# 25.08.02 이슈 정리

Expo TypeScript + NativeWindCSS v4 환경 구축 및 환경변수 설정 과정에서 발생한 이슈들과 해결 방법을 정리한 문서

## 📦 프로젝트 현황

### 기존 환경

- **Expo SDK**: ~53.0.20
- **NativeWind**: v4.1.23 (v2 설정으로 구성되어 있었음)
- **React Native**: 0.79.5
- **TypeScript**: ~5.8.3

### 설치된 라이브러리

```bash
# 기본 의존성 (이미 설치됨)
- @supabase/supabase-js@^2.53.0
- @tanstack/react-query@^5.83.0
- react-native-worklets@^0.4.1
- nativewind@^4.1.23
```

## 🚨 발생한 이슈들과 해결 방법

### 이슈 1: 환경변수 하드코딩 문제

**문제**: Supabase URL과 anon key가 코드에 하드코딩되어 보안상 취약함

**해결 방법**:

1. **`.env` 파일 생성**:

```bash
# Supabase 설정
EXPO_PUBLIC_SUPABASE_URL=your_supabase_project_url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# 앱 환경 설정
EXPO_PUBLIC_APP_ENV=development

# 카페인 관련 설정
EXPO_PUBLIC_CAFFEINE_HALF_LIFE=5.5
EXPO_PUBLIC_DEFAULT_DAILY_LIMIT=400
```

2. **TypeScript 타입 정의 업데이트** (`types/env.d.ts`):

```typescript
declare global {
  namespace NodeJS {
    interface ProcessEnv {
      EXPO_PUBLIC_SUPABASE_URL: string;
      EXPO_PUBLIC_SUPABASE_ANON_KEY: string;
      EXPO_PUBLIC_APP_ENV: 'development' | 'staging' | 'production';
      EXPO_PUBLIC_CAFFEINE_HALF_LIFE: string;
      EXPO_PUBLIC_DEFAULT_DAILY_LIMIT: string;
    }
  }
}
```

3. **상수 관리 시스템 구축** (`src/utils/constants.ts`):

```typescript
export const CAFFEINE_HALF_LIFE = parseFloat(
  process.env.EXPO_PUBLIC_CAFFEINE_HALF_LIFE || '5.5'
);

export const BROWN_COLORS = {
  brown: {
    500: '#A0715D', // 메인 브라운
    // ...브라운 팔레트
  },
} as const;
```

### 이슈 2: NativeWind v4와 v2 설정 충돌 (핵심 문제)

**증상**:

```bash
[Reanimated] Seems like you are using a Babel plugin `react-native-reanimated/plugin`.
It was moved to `react-native-worklets` package.
Please use `react-native-worklets/plugin` instead.

ERROR index.ts: [BABEL] .plugins is not a valid Plugin property
```

**원인**:

- NativeWind v4가 설치되어 있지만 v2 방식의 Babel 설정을 사용
- NativeWind v4는 아키텍처가 완전히 변경되어 Babel 대신 Metro에서 CSS 처리
- `react-native-reanimated`이 의존성으로 설치되어 있지만 호환성 문제 발생

**해결 방법**:

1. **NativeWind v4 호환 babel.config.js 설정**:

```javascript
module.exports = function (api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'], // jsxImportSource 제거
    plugins: ['react-native-worklets/plugin'], // nativewind/babel 제거
  };
};
```

2. **metro.config.js 설정 유지** (이미 v4 방식):

```javascript
const { getDefaultConfig } = require('expo/metro-config');
const { withNativeWind } = require('nativewind/metro');

const config = getDefaultConfig(__dirname);
module.exports = withNativeWind(config, {
  input: './assets/styles/global.css',
});
```

3. **완전한 의존성 재설치**:

```bash
rm -rf node_modules package-lock.json
npm install
npx expo start --clear
```

### 이슈 3: 브라운 테마 시스템 구축

**요구사항**: 다크모드 대신 브라운 컬러 기반 단일 테마 시스템

**해결 방법**:

1. **tailwind.config.js 브라운 팔레트 적용**:

```javascript
module.exports = {
  content: ['./App.tsx', './src/**/*.{js,jsx,ts,tsx}'],
  presets: [require('nativewind/preset')],
  theme: {
    extend: {
      colors: {
        primary: {
          500: '#A0715D', // 메인 브라운
          // ...브라운 스케일
        },
        caffeine: {
          light: '#8B4513',
          DEFAULT: '#A0715D',
          dark: '#D2691E',
        },
      },
    },
  },
};
```

2. **global.css 브라운 테마 스타일**:

```css
:root {
  --color-background: #fdf8f6;
  --color-primary: #a0715d;
  --color-caffeine: #8b4513;
}

.btn-primary {
  @apply bg-primary-500 text-white px-6 py-3 rounded-xl font-semibold;
}

.caffeine-progress-fill {
  @apply h-full bg-gradient-to-r from-caffeine-light via-caffeine to-caffeine-dark;
}
```

### 이슈 4: SecureStore 웹 호환성 문제 (부차적 문제)

**증상**:

```
TypeError: _ExpoSecureStore.default.getValueWithKeyAsync is not a function
```

**원인**: expo-secure-store가 웹 환경에서 지원하지 않는 API 사용

**현재 상태**: 모바일에서는 정상 작동, 웹에서만 발생하는 경고

**향후 해결 방안**:

```typescript
// 웹용 fallback 추가 예정
const storage = Platform.OS === 'web' ? AsyncStorage : SecureStore;
```

## 🔧 NativeWind v4 핵심 변경점

### v2 → v4 마이그레이션 포인트

| 설정           | v2 방식                          | v4 방식                    |
| -------------- | -------------------------------- | -------------------------- |
| **Babel 설정** | `nativewind/babel` 플러그인 필요 | 플러그인 불필요            |
| **JSX Import** | `jsxImportSource: 'nativewind'`  | 설정 불필요                |
| **CSS 처리**   | Babel에서 처리                   | Metro transformer에서 처리 |
| **Metro 설정** | 선택적                           | `withNativeWind()` 필수    |

### 올바른 v4 설정 체크리스트

- [ ] `babel.config.js`에서 `nativewind/babel` 제거
- [ ] `babel.config.js`에서 `jsxImportSource` 제거
- [ ] `metro.config.js`에 `withNativeWind()` 적용
- [ ] `tailwind.config.js`에 `nativewind/preset` 적용
- [ ] 의존성 재설치 및 캐시 클리어

## 📚 참고 자료

- [NativeWind v4 공식 문서](https://www.nativewind.dev/docs/getting-started/installation)
- [NativeWind v4 GitHub 이슈](https://github.com/nativewind/nativewind/issues/600#issuecomment-1804741121)
- [Expo 환경변수 가이드](https://docs.expo.dev/guides/environment-variables/)

## 💡 교훈

1. **버전 호환성 주의**: NativeWind v4는 v2와 완전히 다른 아키텍처
2. **공식 문서 우선**: AI 도구들이 과거 버전 설정을 제공할 수 있음
3. **단계별 디버깅**: 의존성 트리 확인으로 근본 원인 파악
4. **환경변수 보안**: 초기 설정부터 환경변수 시스템 구축 필요
5. **완전한 재설치**: 설정 변경 시 node_modules 완전 삭제 후 재설치

## 🎯 해결 결과

- ✅ **NativeWind v4 설정 완료**: `.plugins is not a valid Plugin property` 에러 해결
- ✅ **환경변수 시스템 구축**: Supabase 연결 정보 보안 처리
- ✅ **브라운 테마 시스템**: 단일 테마 기반 디자인 시스템 구축
- ✅ **앱 정상 실행**: 웹/모바일 환경에서 정상 번들링 및 실행

## 🚀 다음 단계

1. **사용자 인증 시스템 구현** (고우선순위)
2. **데이터베이스 스키마 생성** (고우선순위)
3. **React Query 캐싱 시스템 구축** (중우선순위)
4. **SecureStore 웹 호환성 개선** (저우선순위)
