# 카페인 추적 앱 설계 문서

## 1. 프로젝트 개요

### 1.1 서비스 아이디어

**CaffeineTracker** - 사용자의 카페인 섭취량을 실시간으로 추적하고, 개인별 권장량을 기준으로 건강한 카페인 섭취를 도와주는 모바일 앱

### 1.2 핵심 기능

- 실시간 카페인 섭취량 추적
- 개인 맞춤형 일일 카페인 권장량 계산
- 카페인 분해 시간을 고려한 자동 감소 시스템
- 직관적인 프로그래스 바 UI
- 다양한 커피/음료 데이터베이스

### 1.3 타겟 사용자

- 카페인 섭취를 관리하고 싶은 성인
- 건강한 생활을 추구하는 사람들
- 커피 애호가들

## 2. 기술 스택

### 2.1 Frontend

- **React Native (Expo)**: 크로스 플랫폼 모바일 앱 개발
- **NativeWindCSS**: Tailwind CSS 기반 스타일링
- **Ionicons**: 아이콘 라이브러리
- **React Navigation**: 화면 네비게이션

### 2.2 Backend & Database

- **Supabase**:
  - PostgreSQL 데이터베이스
  - 실시간 구독
  - 인증 시스템
  - REST API

### 2.3 추가 라이브러리 (예상)

- **@supabase/supabase-js**: Supabase 클라이언트
- **@tanstack/react-query**: 데이터 패칭 및 상태 관리
- **React Hook Form**: 폼 관리
- **@react-native-async-storage/async-storage**: 로컬 저장소 및 캐싱
- **expo-system-ui**: 시스템 UI 테마 감지
- **react-native-appearance**: 시스템 테마 변경 감지
- **expo-secure-store**: 민감한 데이터 암호화 저장

## 3. 환경변수 및 보안 설정

### 3.1 환경변수 구성 (.env)

```bash
# .env.example
EXPO_PUBLIC_SUPABASE_URL=your_supabase_project_url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# 개발환경용
EXPO_PUBLIC_APP_ENV=development

# API 관련
EXPO_PUBLIC_API_BASE_URL=https://your-api.supabase.co

# 캐싱 설정
EXPO_PUBLIC_CACHE_DURATION=300000  # 5분 (밀리초)
EXPO_PUBLIC_OFFLINE_CACHE_DURATION=86400000  # 24시간
```

### 3.2 Supabase 클라이언트 설정

```javascript
// lib/supabase.js
import { createClient } from '@supabase/supabase-js';
import * as SecureStore from 'expo-secure-store';

// 환경변수 검증
const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Supabase 환경변수가 설정되지 않았습니다.');
}

// SecureStore 어댑터 (토큰 암호화 저장)
const ExpoSecureStoreAdapter = {
  getItem: (key) => {
    return SecureStore.getItemAsync(key);
  },
  setItem: (key, value) => {
    SecureStore.setItemAsync(key, value);
  },
  removeItem: (key) => {
    SecureStore.deleteItemAsync(key);
  },
};

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    storage: ExpoSecureStoreAdapter,
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
});
```

### 3.3 환경변수 타입 정의

```typescript
// types/env.d.ts
declare module '@env' {
  export const EXPO_PUBLIC_SUPABASE_URL: string;
  export const EXPO_PUBLIC_SUPABASE_ANON_KEY: string;
  export const EXPO_PUBLIC_APP_ENV: 'development' | 'staging' | 'production';
  export const EXPO_PUBLIC_API_BASE_URL: string;
  export const EXPO_PUBLIC_CACHE_DURATION: string;
  export const EXPO_PUBLIC_OFFLINE_CACHE_DURATION: string;
}
```

## 4. 캐싱 시스템 설계 (AsyncStorage)

### 4.1 React Query 설정

```javascript
// lib/queryClient.js
import { QueryClient } from '@tanstack/react-query';
import AsyncStorage from '@react-native-async-storage/async-storage';

// React Query 클라이언트 설정
export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5분
      cacheTime: 30 * 60 * 1000, // 30분
      retry: 2,
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 10000),
      refetchOnWindowFocus: false,
      refetchOnReconnect: true,
    },
    mutations: {
      retry: 1,
    },
  },
});
```

### 4.2 AsyncStorage 캐시 헬퍼

```javascript
// utils/cache.js
import AsyncStorage from '@react-native-async-storage/async-storage';

const CACHE_PREFIX = 'caffeine_cache_';
const DEFAULT_TTL = 5 * 60 * 1000; // 5분

export const cache = {
  async set(key, value, ttl = DEFAULT_TTL) {
    try {
      const item = {
        value,
        timestamp: Date.now(),
        ttl,
      };
      await AsyncStorage.setItem(`${CACHE_PREFIX}${key}`, JSON.stringify(item));
    } catch (error) {
      console.warn('캐시 저장 실패:', error);
    }
  },

  async get(key) {
    try {
      const item = await AsyncStorage.getItem(`${CACHE_PREFIX}${key}`);
      if (!item) return null;

      const parsed = JSON.parse(item);
      const now = Date.now();

      // TTL 체크
      if (now - parsed.timestamp > parsed.ttl) {
        await this.delete(key);
        return null;
      }

      return parsed.value;
    } catch (error) {
      console.warn('캐시 로드 실패:', error);
      return null;
    }
  },

  async delete(key) {
    try {
      await AsyncStorage.removeItem(`${CACHE_PREFIX}${key}`);
    } catch (error) {
      console.warn('캐시 삭제 실패:', error);
    }
  },

  async clear() {
    try {
      const keys = await AsyncStorage.getAllKeys();
      const cacheKeys = keys.filter((key) => key.startsWith(CACHE_PREFIX));
      await AsyncStorage.multiRemove(cacheKeys);
    } catch (error) {
      console.warn('캐시 전체 삭제 실패:', error);
    }
  },
};
```

### 4.3 데이터 패칭 훅

```javascript
// hooks/useCaffeineData.js
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '../lib/supabase';
import { cache } from '../utils/cache';

export function useCaffeineData(userId) {
  return useQuery({
    queryKey: ['caffeine', userId],
    queryFn: async () => {
      // 캐시된 데이터 먼저 확인
      const cached = await cache.get(`caffeine_${userId}`);
      if (cached) return cached;

      const { data, error } = await supabase
        .from('users')
        .select('current_caffeine, daily_caffeine_limit')
        .eq('id', userId)
        .single();

      if (error) throw error;

      // 캐시에 저장 (30초)
      await cache.set(`caffeine_${userId}`, data, 30 * 1000);
      return data;
    },
    staleTime: 30 * 1000, // 30초
  });
}

export function useCaffeineItems() {
  return useQuery({
    queryKey: ['caffeine-items'],
    queryFn: async () => {
      // 캐시된 데이터 먼저 확인
      const cached = await cache.get('caffeine_items');
      if (cached) return cached;

      const { data, error } = await supabase
        .from('caffeine_items')
        .select('*')
        .order('display_order');

      if (error) throw error;

      // 캐시에 저장 (1시간)
      await cache.set('caffeine_items', data, 60 * 60 * 1000);
      return data;
    },
    staleTime: 60 * 60 * 1000, // 1시간
  });
}

export function useAddCaffeine() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ userId, itemId, caffeineAmount }) => {
      const { data, error } = await supabase
        .from('caffeine_logs')
        .insert({
          user_id: userId,
          caffeine_item_id: itemId,
          caffeine_amount: caffeineAmount,
          metabolism_complete_at: new Date(
            Date.now() + 6 * 60 * 60 * 1000 // 6시간 후
          ).toISOString(),
        })
        .select()
        .single();

      if (error) throw error;

      // 사용자의 현재 카페인량 업데이트
      const { error: updateError } = await supabase
        .from('users')
        .update({
          current_caffeine: supabase.raw(
            `current_caffeine + ${caffeineAmount}`
          ),
        })
        .eq('id', userId);

      if (updateError) throw updateError;

      return data;
    },
    onSuccess: (data, variables) => {
      // 캐시 무효화
      queryClient.invalidateQueries(['caffeine', variables.userId]);
      cache.delete(`caffeine_${variables.userId}`);
    },
  });
}
```

### 4.4 오프라인 지원

```javascript
// hooks/useOfflineSupport.js
import { useEffect, useState } from 'react';
import NetInfo from '@react-native-community/netinfo';
import { cache } from '../utils/cache';

export function useOfflineSupport() {
  const [isOnline, setIsOnline] = useState(true);
  const [pendingActions, setPendingActions] = useState([]);

  useEffect(() => {
    const unsubscribe = NetInfo.addEventListener((state) => {
      setIsOnline(state.isConnected);

      // 온라인 복구 시 대기 중인 액션 실행
      if (state.isConnected && pendingActions.length > 0) {
        processPendingActions();
      }
    });

    loadPendingActions();
    return unsubscribe;
  }, []);

  const loadPendingActions = async () => {
    const pending = await cache.get('pending_actions');
    if (pending) {
      setPendingActions(pending);
    }
  };

  const addPendingAction = async (action) => {
    const updated = [...pendingActions, { ...action, timestamp: Date.now() }];
    setPendingActions(updated);
    await cache.set('pending_actions', updated, 24 * 60 * 60 * 1000); // 24시간
  };

  const processPendingActions = async () => {
    // 대기 중인 액션들을 순차적으로 실행
    for (const action of pendingActions) {
      try {
        await executeAction(action);
      } catch (error) {
        console.warn('오프라인 액션 실행 실패:', error);
      }
    }

    setPendingActions([]);
    await cache.delete('pending_actions');
  };

  return {
    isOnline,
    addPendingAction,
    pendingActions: pendingActions.length,
  };
}
```

## 5. 데이터베이스 스키마

### 5.1 Users Table

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
  age INTEGER CHECK (age >= 13 AND age <= 120),
  weight DECIMAL(5,2) CHECK (weight > 0),
  daily_caffeine_limit INTEGER DEFAULT 400, -- mg
  current_caffeine DECIMAL(6,2) DEFAULT 0, -- mg
  theme_preference VARCHAR(10) DEFAULT 'system' CHECK (theme_preference IN ('light', 'dark', 'system')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 5.2 Coffee Items Table

```sql
CREATE TABLE caffeine_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category VARCHAR(20) NOT NULL CHECK (category IN ('coffee', 'energy_drink')),
  brand VARCHAR(50) NOT NULL, -- 스타벅스, 메가커피, 컴포즈커피, 빽다방, 몬스터, 레드불, 핫식스
  name VARCHAR(100) NOT NULL, -- 아이스 아메리카노, 카페라떼, 몬스터 화이트 등
  size VARCHAR(20), -- S, M, L, XL (커피만 해당, 에너지 드링크는 NULL)
  caffeine_content DECIMAL(6,2) NOT NULL, -- mg
  serving_size_ml INTEGER, -- ml
  icon_name VARCHAR(50), -- ionicon name
  display_order INTEGER DEFAULT 0, -- 표시 순서
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스 추가
CREATE INDEX idx_caffeine_items_category ON caffeine_items(category);
CREATE INDEX idx_caffeine_items_brand ON caffeine_items(brand);
CREATE INDEX idx_caffeine_items_category_brand ON caffeine_items(category, brand);
```

### 5.3 초기 데이터 삽입

```sql
-- 커피 브랜드 데이터
INSERT INTO caffeine_items (category, brand, name, size, caffeine_content, serving_size_ml, icon_name, display_order) VALUES
-- 스타벅스
('coffee', '스타벅스', '아이스 아메리카노', 'S', 150, 355, 'cafe-outline', 1),
('coffee', '스타벅스', '아이스 아메리카노', 'M', 225, 473, 'cafe-outline', 2),
('coffee', '스타벅스', '아이스 아메리카노', 'L', 300, 591, 'cafe-outline', 3),
('coffee', '스타벅스', '카페라떼', 'S', 75, 355, 'cafe-outline', 4),
('coffee', '스타벅스', '카페라떼', 'M', 150, 473, 'cafe-outline', 5),
('coffee', '스타벅스', '카페라떼', 'L', 225, 591, 'cafe-outline', 6),

-- 메가커피
('coffee', '메가커피', '아이스 아메리카노', 'M', 120, 500, 'cafe-outline', 7),
('coffee', '메가커피', '아이스 아메리카노', 'L', 180, 650, 'cafe-outline', 8),
('coffee', '메가커피', '카페라떼', 'M', 80, 500, 'cafe-outline', 9),
('coffee', '메가커피', '카페라떼', 'L', 120, 650, 'cafe-outline', 10),

-- 컴포즈커피
('coffee', '컴포즈커피', '아이스 아메리카노', 'M', 115, 473, 'cafe-outline', 11),
('coffee', '컴포즈커피', '아이스 아메리카노', 'L', 175, 591, 'cafe-outline', 12),
('coffee', '컴포즈커피', '카페라떼', 'M', 75, 473, 'cafe-outline', 13),
('coffee', '컴포즈커피', '카페라떼', 'L', 115, 591, 'cafe-outline', 14),

-- 빽다방
('coffee', '빽다방', '아이스 아메리카노', 'M', 110, 473, 'cafe-outline', 15),
('coffee', '빽다방', '아이스 아메리카노', 'L', 165, 591, 'cafe-outline', 16),
('coffee', '빽다방', '카페라떼', 'M', 70, 473, 'cafe-outline', 17),
('coffee', '빽다방', '카페라떼', 'L', 110, 591, 'cafe-outline', 18),

-- 에너지 드링크
('energy_drink', '몬스터', '몬스터 오리지널', NULL, 160, 355, 'flash-outline', 19),
('energy_drink', '몬스터', '몬스터 화이트', NULL, 140, 355, 'flash-outline', 20),
('energy_drink', '몬스터', '몬스터 울트라', NULL, 140, 355, 'flash-outline', 21),

('energy_drink', '레드불', '레드불 오리지널', NULL, 80, 250, 'flash-outline', 22),
('energy_drink', '레드불', '레드불 슈가프리', NULL, 80, 250, 'flash-outline', 23),
('energy_drink', '레드불', '레드불 블루', NULL, 80, 250, 'flash-outline', 24),

('energy_drink', '핫식스', '핫식스 오리지널', NULL, 60, 250, 'flash-outline', 25),
('energy_drink', '핫식스', '핫식스 제로', NULL, 60, 250, 'flash-outline', 26),
('energy_drink', '핫식스', '핫식스 킹', NULL, 120, 355, 'flash-outline', 27);
```

### 5.4 Caffeine Logs Table

```sql
CREATE TABLE caffeine_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  caffeine_item_id UUID REFERENCES caffeine_items(id),
  caffeine_amount DECIMAL(6,2) NOT NULL, -- mg
  consumed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  metabolism_complete_at TIMESTAMP WITH TIME ZONE, -- 카페인 완전 분해 예상 시간
  is_active BOOLEAN DEFAULT TRUE, -- 아직 분해 중인지 여부
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 5.5 User Profiles View (계산된 권장량)

```sql
CREATE OR REPLACE FUNCTION calculate_daily_limit(user_age INTEGER, user_weight DECIMAL, user_gender VARCHAR)
RETURNS INTEGER AS $$
BEGIN
  -- 기본 권장량: 체중 1kg당 5-6mg, 최대 400mg
  -- 나이별 조정: 18세 미만 제한, 65세 이상 감소
  -- 성별별 조정: 여성의 경우 약간 감소

  DECLARE
    base_limit INTEGER;
    age_factor DECIMAL := 1.0;
    gender_factor DECIMAL := 1.0;
  BEGIN
    -- 체중 기반 계산
    base_limit := LEAST(user_weight * 5.5, 400);

    -- 나이 조정
    IF user_age < 18 THEN
      age_factor := 0.5;
    ELSIF user_age > 65 THEN
      age_factor := 0.8;
    END IF;

    -- 성별 조정
    IF user_gender = 'female' THEN
      gender_factor := 0.9;
    END IF;

    RETURN ROUND(base_limit * age_factor * gender_factor);
  END;
END;
$$ LANGUAGE plpgsql;
```

## 6. 앱 구조 설계

### 6.1 화면 구성

```
App
├── AuthStack
│   ├── LoginScreen
│   ├── SignUpScreen
│   └── ForgotPasswordScreen
├── MainStack
│   ├── HomeScreen (메인 대시보드)
│   ├── CaffeineSelectionScreen (계층적 카페인 선택)
│   ├── ProfileScreen (프로필 수정)
│   ├── HistoryScreen (섭취 기록)
│   └── SettingsScreen
```

### 6.2 주요 컴포넌트

- **CaffeineProgressBar**: 현재 섭취량 시각화
- **CaffeineHierarchySelector**: 계층적 카페인 선택 컴포넌트
- **CategoryButton**: 카테고리 선택 버튼 (커피/에너지 드링크)
- **BrandButton**: 브랜드 선택 버튼
- **DrinkButton**: 음료 선택 버튼
- **SizeButton**: 사이즈 선택 버튼 (커피만)
- **ProfileForm**: 사용자 정보 입력 폼
- **CaffeineChart**: 일별/주별 섭취량 차트
- **ThemeProvider**: 테마 컨텍스트 제공자
- **ThemeToggle**: 테마 전환 버튼
- **ThemedView/ThemedText**: 테마 적용 기본 컴포넌트

### 6.3 계층적 선택 컴포넌트 구조

```javascript
// components/CaffeineHierarchySelector.js
import React, { useState } from 'react';
import { View, ScrollView } from 'react-native';
import { CategoryButton } from './CategoryButton';
import { BrandButton } from './BrandButton';
import { DrinkButton } from './DrinkButton';
import { SizeButton } from './SizeButton';

export function CaffeineHierarchySelector({ onSelect }) {
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [selectedBrand, setSelectedBrand] = useState(null);
  const [selectedDrink, setSelectedDrink] = useState(null);
  const [selectedSize, setSelectedSize] = useState(null);

  const categories = [
    { id: 'coffee', name: '커피', icon: 'cafe-outline' },
    { id: 'energy_drink', name: '에너지 드링크', icon: 'flash-outline' },
  ];

  const brands = {
    coffee: [
      { id: 'starbucks', name: '스타벅스', icon: 'storefront-outline' },
      { id: 'mega', name: '메가커피', icon: 'storefront-outline' },
      { id: 'compose', name: '컴포즈커피', icon: 'storefront-outline' },
      { id: 'paik', name: '빽다방', icon: 'storefront-outline' },
    ],
    energy_drink: [
      { id: 'monster', name: '몬스터', icon: 'flash-outline' },
      { id: 'redbull', name: '레드불', icon: 'flash-outline' },
      { id: 'hotsix', name: '핫식스', icon: 'flash-outline' },
    ],
  };

  const drinks = {
    coffee: [
      { id: 'americano', name: '아이스 아메리카노', icon: 'cafe-outline' },
      { id: 'latte', name: '카페라떼', icon: 'cafe-outline' },
    ],
    energy_drink: {
      monster: [
        { id: 'original', name: '몬스터 오리지널', caffeine: 160 },
        { id: 'white', name: '몬스터 화이트', caffeine: 140 },
        { id: 'ultra', name: '몬스터 울트라', caffeine: 140 },
      ],
      redbull: [
        { id: 'original', name: '레드불 오리지널', caffeine: 80 },
        { id: 'sugar_free', name: '레드불 슈가프리', caffeine: 80 },
        { id: 'blue', name: '레드불 블루', caffeine: 80 },
      ],
      hotsix: [
        { id: 'original', name: '핫식스 오리지널', caffeine: 60 },
        { id: 'zero', name: '핫식스 제로', caffeine: 60 },
        { id: 'king', name: '핫식스 킹', caffeine: 120 },
      ],
    },
  };

  const sizes = [
    { id: 'S', name: 'Small', multiplier: 1.0 },
    { id: 'M', name: 'Medium', multiplier: 1.5 },
    { id: 'L', name: 'Large', multiplier: 2.0 },
  ];

  const resetSelection = (level) => {
    if (level <= 1) setSelectedBrand(null);
    if (level <= 2) setSelectedDrink(null);
    if (level <= 3) setSelectedSize(null);
  };

  const handleCategorySelect = (category) => {
    setSelectedCategory(category);
    resetSelection(1);
  };

  const handleBrandSelect = (brand) => {
    setSelectedBrand(brand);
    resetSelection(2);
  };

  const handleDrinkSelect = (drink) => {
    setSelectedDrink(drink);
    resetSelection(3);

    // 에너지 드링크는 사이즈가 없으므로 바로 완료
    if (selectedCategory === 'energy_drink') {
      onSelect({
        category: selectedCategory,
        brand: selectedBrand,
        drink: drink,
        caffeine: drink.caffeine,
      });
    }
  };

  const handleSizeSelect = (size) => {
    setSelectedSize(size);

    // 커피 선택 완료
    onSelect({
      category: selectedCategory,
      brand: selectedBrand,
      drink: selectedDrink,
      size: size,
      caffeine: calculateCoffeCaffeine(
        selectedBrand,
        selectedDrink.id,
        size.id
      ),
    });
  };

  return (
    <ScrollView className="flex-1 p-4">
      {/* 1단계: 카테고리 선택 */}
      <View className="mb-6">
        <ThemedText className="text-lg font-bold mb-3">
          카테고리 선택
        </ThemedText>
        <View className="flex-row space-x-3">
          {categories.map((category) => (
            <CategoryButton
              key={category.id}
              category={category}
              isSelected={selectedCategory === category.id}
              onPress={() => handleCategorySelect(category.id)}
            />
          ))}
        </View>
      </View>

      {/* 2단계: 브랜드 선택 */}
      {selectedCategory && (
        <View className="mb-6">
          <ThemedText className="text-lg font-bold mb-3">
            브랜드 선택
          </ThemedText>
          <View className="flex-row flex-wrap">
            {brands[selectedCategory].map((brand) => (
              <BrandButton
                key={brand.id}
                brand={brand}
                isSelected={selectedBrand === brand.id}
                onPress={() => handleBrandSelect(brand.id)}
              />
            ))}
          </View>
        </View>
      )}

      {/* 3단계: 음료 선택 */}
      {selectedBrand && (
        <View className="mb-6">
          <ThemedText className="text-lg font-bold mb-3">음료 선택</ThemedText>
          <View className="space-y-2">
            {(selectedCategory === 'coffee'
              ? drinks.coffee
              : drinks.energy_drink[selectedBrand]
            ).map((drink) => (
              <DrinkButton
                key={drink.id}
                drink={drink}
                isSelected={selectedDrink?.id === drink.id}
                onPress={() => handleDrinkSelect(drink)}
              />
            ))}
          </View>
        </View>
      )}

      {/* 4단계: 사이즈 선택 (커피만) */}
      {selectedDrink && selectedCategory === 'coffee' && (
        <View className="mb-6">
          <ThemedText className="text-lg font-bold mb-3">
            사이즈 선택
          </ThemedText>
          <View className="flex-row space-x-3">
            {sizes.map((size) => (
              <SizeButton
                key={size.id}
                size={size}
                isSelected={selectedSize?.id === size.id}
                onPress={() => handleSizeSelect(size)}
              />
            ))}
          </View>
        </View>
      )}
    </ScrollView>
  );
}

function calculateCoffeCaffeine(brand, drink, size) {
  // 브랜드별, 음료별, 사이즈별 카페인 계산 로직
  const baseCaffeine = {
    starbucks: {
      americano: { S: 150, M: 225, L: 300 },
      latte: { S: 75, M: 150, L: 225 },
    },
    mega: { americano: { M: 120, L: 180 }, latte: { M: 80, L: 120 } },
    compose: { americano: { M: 115, L: 175 }, latte: { M: 75, L: 115 } },
    paik: { americano: { M: 110, L: 165 }, latte: { M: 70, L: 110 } },
  };

  return baseCaffeine[brand]?.[drink]?.[size] || 0;
}
```

## 7. 비즈니스 로직

### 7.1 카페인 분해 시스템

```javascript
// 카페인 반감기: 약 5-6시간
const CAFFEINE_HALF_LIFE = 5.5; // hours

function calculateRemainingCaffeine(initialAmount, hoursElapsed) {
  return initialAmount * Math.pow(0.5, hoursElapsed / CAFFEINE_HALF_LIFE);
}

function updateUserCaffeine(userId) {
  // 활성 로그들의 현재 카페인량 계산 후 업데이트
  // 10mg 이하일 때 로그를 비활성화
}
```

### 7.2 일일 권장량 계산

```javascript
function calculateDailyLimit(age, weight, gender) {
  let baseLimit = Math.min(weight * 5.5, 400);

  // 나이 조정
  if (age < 18) baseLimit *= 0.5;
  else if (age > 65) baseLimit *= 0.8;

  // 성별 조정
  if (gender === 'female') baseLimit *= 0.9;

  return Math.round(baseLimit);
}
```

## 8. 테마 시스템 설계

### 8.1 테마 구조

```javascript
// theme/colors.js
export const colors = {
  light: {
    primary: '#8B5CF6', // 보라색
    secondary: '#06B6D4', // 청록색
    background: '#FFFFFF',
    surface: '#F8FAFC',
    card: '#FFFFFF',
    text: '#1F2937',
    textSecondary: '#6B7280',
    border: '#E5E7EB',
    error: '#EF4444',
    success: '#10B981',
    warning: '#F59E0B',
    caffeine: '#8B4513', // 카페인 관련 브라운
    progressBg: '#E5E7EB',
    progressFill: '#8B5CF6',
  },
  dark: {
    primary: '#A78BFA', // 밝은 보라색
    secondary: '#22D3EE', // 밝은 청록색
    background: '#111827',
    surface: '#1F2937',
    card: '#374151',
    text: '#F9FAFB',
    textSecondary: '#D1D5DB',
    border: '#4B5563',
    error: '#F87171',
    success: '#34D399',
    warning: '#FBBF24',
    caffeine: '#D2691E', // 밝은 브라운
    progressBg: '#4B5563',
    progressFill: '#A78BFA',
  },
};
```

### 8.2 NativeWindCSS 다크모드 설정

```javascript
// tailwind.config.js
module.exports = {
  content: ['./App.{js,jsx,ts,tsx}', './src/**/*.{js,jsx,ts,tsx}'],
  darkMode: 'class', // 클래스 기반 다크모드
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#F5F3FF',
          500: '#8B5CF6',
          600: '#7C3AED',
          700: '#6D28D9',
        },
        caffeine: {
          light: '#8B4513',
          dark: '#D2691E',
        },
      },
    },
  },
  plugins: [],
};
```

### 8.3 테마 컨텍스트

```javascript
// context/ThemeContext.js
import React, { createContext, useContext, useEffect, useState } from 'react';
import { Appearance } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';

const ThemeContext = createContext();

export function ThemeProvider({ children }) {
  const [theme, setTheme] = useState('system');
  const [isDark, setIsDark] = useState(false);

  useEffect(() => {
    loadThemePreference();

    const subscription = Appearance.addChangeListener(({ colorScheme }) => {
      if (theme === 'system') {
        setIsDark(colorScheme === 'dark');
      }
    });

    return () => subscription?.remove();
  }, [theme]);

  const loadThemePreference = async () => {
    try {
      const savedTheme = await AsyncStorage.getItem('theme_preference');
      if (savedTheme) {
        setTheme(savedTheme);
        updateTheme(savedTheme);
      } else {
        updateTheme('system');
      }
    } catch (error) {
      console.error('테마 로드 실패:', error);
    }
  };

  const updateTheme = (newTheme) => {
    setTheme(newTheme);

    if (newTheme === 'system') {
      const systemTheme = Appearance.getColorScheme();
      setIsDark(systemTheme === 'dark');
    } else {
      setIsDark(newTheme === 'dark');
    }
  };

  const changeTheme = async (newTheme) => {
    try {
      await AsyncStorage.setItem('theme_preference', newTheme);
      updateTheme(newTheme);

      // Supabase에도 저장
      if (user) {
        await supabase
          .from('users')
          .update({ theme_preference: newTheme })
          .eq('id', user.id);
      }
    } catch (error) {
      console.error('테마 저장 실패:', error);
    }
  };

  return (
    <ThemeContext.Provider
      value={{
        theme,
        isDark,
        changeTheme,
        colors: colors[isDark ? 'dark' : 'light'],
      }}
    >
      {children}
    </ThemeContext.Provider>
  );
}

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider');
  }
  return context;
};
```

### 8.4 테마 적용 컴포넌트

```javascript
// components/themed/ThemedView.js
import React from 'react';
import { View } from 'react-native';
import { useTheme } from '../../context/ThemeContext';

export function ThemedView({ className, style, ...props }) {
  const { isDark } = useTheme();

  const themeClass = isDark ? 'dark' : '';
  const combinedClassName = `${themeClass} ${className || ''}`;

  return <View className={combinedClassName} style={style} {...props} />;
}

// components/themed/ThemedText.js
import React from 'react';
import { Text } from 'react-native';
import { useTheme } from '../../context/ThemeContext';

export function ThemedText({ className, style, ...props }) {
  const { colors } = useTheme();

  return (
    <Text
      className={className}
      style={[{ color: colors.text }, style]}
      {...props}
    />
  );
}
```

### 8.5 테마 토글 컴포넌트

```javascript
// components/ThemeToggle.js
import React from 'react';
import { TouchableOpacity, View } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useTheme } from '../context/ThemeContext';
import { ThemedText } from './themed/ThemedText';

export function ThemeToggle() {
  const { theme, isDark, changeTheme, colors } = useTheme();

  const themeOptions = [
    { key: 'light', label: '라이트', icon: 'sunny-outline' },
    { key: 'dark', label: '다크', icon: 'moon-outline' },
    { key: 'system', label: '시스템', icon: 'phone-portrait-outline' },
  ];

  return (
    <View className="bg-white dark:bg-gray-800 rounded-xl p-4 mx-4 mb-4">
      <ThemedText className="text-lg font-semibold mb-3">테마 설정</ThemedText>

      <View className="flex-row justify-between">
        {themeOptions.map((option) => (
          <TouchableOpacity
            key={option.key}
            onPress={() => changeTheme(option.key)}
            className={`
              flex-1 mx-1 p-3 rounded-lg items-center
              ${
                theme === option.key
                  ? 'bg-purple-500 dark:bg-purple-600'
                  : 'bg-gray-100 dark:bg-gray-700'
              }
            `}
          >
            <Ionicons
              name={option.icon}
              size={24}
              color={theme === option.key ? '#FFFFFF' : colors.text}
            />
            <ThemedText
              className={`
                mt-1 text-sm font-medium
                ${theme === option.key ? 'text-white' : ''}
              `}
            >
              {option.label}
            </ThemedText>
          </TouchableOpacity>
        ))}
      </View>
    </View>
  );
}
```

## 9. API 설계

### 9.1 주요 API 엔드포인트

- `GET /api/user/profile` - 사용자 프로필 조회
- `PUT /api/user/profile` - 사용자 프로필 업데이트
- `PUT /api/user/theme` - 사용자 테마 설정 업데이트
- `GET /api/user/current-caffeine` - 현재 카페인 수치
- `POST /api/caffeine/consume` - 카페인 섭취 기록
- `GET /api/caffeine-items` - 카페인 아이템 목록 (카테고리별, 브랜드별)
- `GET /api/caffeine-items/category/:category` - 카테고리별 아이템
- `GET /api/caffeine-items/brand/:brand` - 브랜드별 아이템
- `GET /api/caffeine/history` - 섭취 기록

### 9.2 실시간 업데이트

```javascript
// Supabase 실시간 구독
const subscription = supabase
  .channel('caffeine_updates')
  .on(
    'postgres_changes',
    { event: 'UPDATE', schema: 'public', table: 'users' },
    (payload) => {
      // UI 업데이트
    }
  )
  .subscribe();
```

## 10. 성능 최적화 전략

### 10.1 AsyncStorage 캐싱 전략

```javascript
// 간단한 캐싱 시스템
export const cacheStrategy = {
  // 실시간 데이터 (카페인 수치)
  realtime: {
    ttl: 30 * 1000, // 30초
    key: 'caffeine_data',
  },

  // 준정적 데이터 (사용자 프로필)
  semiStatic: {
    ttl: 5 * 60 * 1000, // 5분
    key: 'user_profile',
  },

  // 정적 데이터 (카페인 아이템 목록)
  static: {
    ttl: 60 * 60 * 1000, // 1시간
    key: 'caffeine_items',
  },
};
```

### 10.2 컴포넌트 최적화

```javascript
// React.memo로 불필요한 리렌더링 방지
import React, { memo } from 'react';

export const CategoryButton = memo(({ category, isSelected, onPress }) => {
  return (
    <TouchableOpacity
      className={`
        flex-1 p-4 rounded-xl items-center
        ${isSelected ? 'bg-purple-500' : 'bg-gray-100 dark:bg-gray-800'}
      `}
      onPress={onPress}
    >
      <Ionicons
        name={category.icon}
        size={32}
        color={isSelected ? '#FFFFFF' : '#6B7280'}
      />
      <ThemedText
        className={`mt-2 font-medium ${isSelected ? 'text-white' : ''}`}
      >
        {category.name}
      </ThemedText>
    </TouchableOpacity>
  );
});

// useMemo로 계산 비용이 높은 연산 최적화
const filteredItems = useMemo(() => {
  return caffeineItems.filter(
    (item) => item.category === selectedCategory && item.brand === selectedBrand
  );
}, [caffeineItems, selectedCategory, selectedBrand]);
```

### 10.3 번들 크기 최적화

```javascript
// metro.config.js
const { getDefaultConfig } = require('@expo/metro-config');

const config = getDefaultConfig(__dirname);

// 사용하지 않는 모듈 제거
config.resolver.platforms = ['ios', 'android', 'native', 'web'];

module.exports = config;
```

## 11. 개발 단계

### Phase 1: 기본 기능 (MVP)

- [ ] 환경변수 설정 및 Supabase 연결
- [ ] 사용자 인증 (SecureStore 암호화)
- [ ] AsyncStorage 기반 캐싱 시스템 구축
- [ ] 기본 프로필 설정
- [ ] 테마 시스템 구축 (라이트/다크/시스템)
- [ ] 홈 화면 카페인 추적
- [ ] 계층적 카페인 선택 시스템 (카테고리 → 브랜드 → 음료 → 사이즈)
- [ ] 초기 카페인 아이템 데이터 입력

### Phase 2: 핵심 기능

- [ ] 카페인 분해 시스템 구현
- [ ] 프로그래스 바 애니메이션 (테마별)
- [ ] 계층적 버튼 UI 완성 및 최적화
- [ ] 섭취 기록 화면
- [ ] 오프라인 지원 (AsyncStorage 캐시 활용)
- [ ] 백그라운드 동기화

### Phase 3: 고급 기능

- [ ] 차트 및 통계 (테마 적용)
- [ ] 알림 시스템
- [ ] 테마 전환 애니메이션
- [ ] 추가 브랜드 및 음료 확장
- [ ] 성능 모니터링
- [ ] 데이터 내보내기

## 12. 고려사항

### 12.1 성능 최적화

- 카페인 계산을 위한 백그라운드 작업 스케줄링
- AsyncStorage 기반 간단한 캐싱 시스템
- React.memo를 활용한 컴포넌트 최적화
- useMemo/useCallback으로 계산 비용 최적화
- 계층적 버튼 선택 시 불필요한 리렌더링 방지

### 12.2 보안

- Expo SecureStore로 민감한 데이터 암호화
- 환경변수로 API 키 관리
- Supabase RLS (Row Level Security) 적용
- 토큰 자동 갱신 및 안전한 저장

### 12.3 사용자 경험

- 오프라인 모드 지원 (AsyncStorage 캐시 활용)
- 계층적 선택 시 부드러운 애니메이션
- 접근성 (Accessibility) 준수
- 다국어 지원 준비
- 시스템 테마 변경 시 즉시 반영
- 다크모드에서의 가독성 최적화

### 12.4 계층적 선택 시스템

- 카테고리별 아이콘 및 색상 일관성
- 선택 상태의 명확한 시각적 피드백
- 이전 단계로 돌아가기 기능
- 각 단계별 적절한 애니메이션
- 에너지 드링크는 사이즈 선택 생략 로직

### 12.5 데이터 정확성

- 브랜드별 카페인 함량 데이터의 신뢰성
- 사용자 입력 데이터 검증
- 의료적 조언이 아님을 명시
- 네트워크 오류 시 캐시된 데이터 활용

이 설계 문서를 바탕으로 단계별로 개발을 진행하시면 됩니다.

**🔐 보안 우선**: 환경변수와 SecureStore를 통한 암호화 처리로 시작
**⚡ 단순한 성능**: AsyncStorage 기반 캐싱으로 간단하면서도 효율적인 시스템  
**🎨 테마 시스템**: 초기 단계에 구축하여 모든 컴포넌트가 다크모드를 지원
**📱 직관적 UI**: 계층적 버튼 선택으로 페이지 이동 없는 부드러운 사용자 경험

**🗂️ 계층적 선택 흐름:**

```
카테고리 선택 (커피/에너지 드링크)
    ↓
브랜드 선택 (스타벅스, 메가, 컴포즈, 빽다방 / 몬스터, 레드불, 핫식스)
    ↓
음료 선택 (아아, 라떼 / 각 브랜드별 3종)
    ↓
사이즈 선택 (커피만: S/M/L)
```
